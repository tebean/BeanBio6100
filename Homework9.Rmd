---
title: "Homework_9"
output: html_document
date: "2025-04-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
```
```{r}
base_dir <- "~/Desktop/UVM/Master's/Spring 2025/Computational Biology/BeanBio6100/count_data"

countdata_files <- list.files(
  path = base_dir,
  pattern = "_count_data\\.[Cc][Ss][Vv]$",  # e.g. 2015_count_data.csv
  full.names = TRUE
)

print(countdata_files)
```

Define helper functions
```{r}
clean_data <- function(df) {
  df %>% drop_na(scientificName, clusterSize)
}

extract_year <- function(file_path) {
  str_extract(basename(file_path), "\\d{4}")
}

calculate_abundance <- function(df) {
  sum(df$clusterSize, na.rm = TRUE)
}

calculate_richness <- function(df) {
  n_distinct(df$scientificName)
}
```
loop through files and build data frames
```{r}
summary_stats <- data.frame()
all_year_data <- data.frame()

for (file in countdata_files) {
  df <- read_csv(file, show_col_types = FALSE)
  df <- clean_data(df)

  # Skip files with missing species or count data
  if (nrow(df) == 0 || all(is.na(df$clusterSize)) || all(is.na(df$scientificName))) {
    cat("Skipping file (no valid data):", basename(file), "\n")
    next
  }

  # Calculate year, abundance, richness
  year <- as.integer(extract_year(file))
  abundance <- calculate_abundance(df)
  richness <- calculate_richness(df)

  # Skip if either stat is missing
  if (is.na(abundance) || is.na(richness)) {
    cat("Skipping file (NA in abundance/richness):", basename(file), "\n")
    next
  }

  # Debug print
  cat("✅ Included — Year:", year, "| Abundance:", abundance, "| Richness:", richness, "\n")

  summary_stats <- rbind(summary_stats, data.frame(
    file = basename(file),
    year = year,
    abundance = abundance,
    richness = richness
  ))

  all_year_data <- rbind(all_year_data, data.frame(
    year = year,
    abundance = abundance,
    richness = richness
  ))
}
```
Regression analysis
```{r}
# Ensure numeric
all_year_data$abundance <- as.numeric(all_year_data$abundance)
all_year_data$richness <- as.numeric(all_year_data$richness)

# Remove NAs
cleaned_data <- all_year_data %>% drop_na(abundance, richness)

# Print for verification
cat("Rows in all_year_data:", nrow(all_year_data), "\n")
cat("Rows in cleaned_data:", nrow(cleaned_data), "\n")
print(head(cleaned_data))

# Run model if data exists
if (nrow(cleaned_data) > 1) {
  model <- lm(richness ~ abundance, data = cleaned_data)
  summary(model)
} else {
  print("Not enough valid data to run regression.")
}
```
Histogram
```{r}
# Use cleaned data if available
plot_data <- if (nrow(cleaned_data) > 0) cleaned_data else all_year_data

# Ensure numeric columns
plot_data$abundance <- as.numeric(plot_data$abundance)
plot_data$richness <- as.numeric(plot_data$richness)

cat("Year:", year, "| Abundance:", abundance, "| Richness:", richness, "\n")

# Filter out NA values
plot_data <- plot_data %>% filter(!is.na(abundance) & !is.na(richness))

# Debug output
cat("Rows available for plotting:", nrow(plot_data), "\n")

# Plot if data exists
if (nrow(plot_data) > 0) {
  ggplot(plot_data, aes(x = abundance)) +
    geom_histogram(binwidth = 10, fill = "skyblue", color = "black") +
    labs(title = "Histogram of Bird Abundance", x = "Abundance", y = "Frequency")

  ggplot(plot_data, aes(x = richness)) +
    geom_histogram(binwidth = 2, fill = "lightgreen", color = "black") +
    labs(title = "Histogram of Species Richness", x = "Richness", y = "Frequency")
} else {
  print("Still no valid data available to plot histograms.")
}
```
```

